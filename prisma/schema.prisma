generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model User {
  id                String      @id @default(cuid())
  name              String?
  email             String      @unique
  emailVerified     DateTime?   @map("email_verified")
  password          String?
  image             String?
  timezone          String      @default("America/Fortaleza")
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")
  oneSignalPlayerId String?     @unique @map("onesignal_player_id")
  accounts          Account[]
  sharedLists       ListShare[]
  lists             List[]
  assignedReminders Reminder[]  @relation("AssignedTo")
  sessions          Session[]
  tags              Tag[]
  preferences       UserPreferences?

  @@map("users")
}

model UserPreferences {
  id                   String               @id @default(cuid())
  userId               String               @unique @map("user_id")
  completedPosition    CompletedPosition    @default(MOVE_TO_BOTTOM) @map("completed_position")
  completedVisibility  CompletedVisibility  @default(SHOW_TODAY_ONLY) @map("completed_visibility")
  undoTimeoutSeconds   Int                  @default(5) @map("undo_timeout_seconds")
  confirmBeforeDelete  Boolean              @default(true) @map("confirm_before_delete")
  createdAt            DateTime             @default(now()) @map("created_at")
  updatedAt            DateTime             @updatedAt @map("updated_at")
  user                 User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model List {
  id        String      @id @default(cuid())
  name      String
  color     String      @default("blue")
  icon      String      @default("list.bullet")
  order     Int         @default(0)
  viewMode  ViewMode    @default(LIST)
  userId    String      @map("user_id")
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")
  shares    ListShare[]
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  reminders Reminder[]
  sections  Section[]

  @@index([userId])
  @@index([order])
  @@map("lists")
}

model ListShare {
  id           String    @id @default(cuid())
  listId       String    @map("list_id")
  sharedWithId String    @map("shared_with_id")
  role         ShareRole @default(VIEWER)
  invitedAt    DateTime  @default(now()) @map("invited_at")
  acceptedAt   DateTime? @map("accepted_at")
  list         List      @relation(fields: [listId], references: [id], onDelete: Cascade)
  sharedWith   User      @relation(fields: [sharedWithId], references: [id], onDelete: Cascade)

  @@unique([listId, sharedWithId])
  @@index([sharedWithId])
  @@map("list_shares")
}

model Section {
  id        String     @id @default(cuid())
  name      String
  order     Int        @default(0)
  listId    String     @map("list_id")
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")
  reminders Reminder[]
  list      List       @relation(fields: [listId], references: [id], onDelete: Cascade)

  @@index([listId, order])
  @@map("sections")
}

model Reminder {
  id                      String              @id @default(cuid())
  title                   String
  notes                   String?
  completed               Boolean             @default(false)
  completedAt             DateTime?           @map("completed_at")
  priority                Priority            @default(NONE)
  utcDatetime             DateTime?           @map("utc_datetime") @db.Timestamptz(6)
  timezone                String?
  isFloating              Boolean             @default(false) @map("is_floating")
  isDateOnly              Boolean             @default(false) @map("is_date_only")
  reminderDate            DateTime?           @map("reminder_date") @db.Date
  dueTime                 String?             @map("due_time")
  startDate               DateTime?           @map("start_date") @db.Date
  order                   Int                 @default(0)
  sortOrder               Int                 @default(0) @map("sort_order")
  parentId                String?             @map("parent_id")
  listId                  String              @map("list_id")
  sectionId               String?             @map("section_id")
  assignedToId            String?             @map("assigned_to_id")
  oneSignalNotificationId String?             @unique @map("onesignal_notification_id")
  createdAt               DateTime            @default(now()) @map("created_at")
  createdTimezone         String              @default("America/Fortaleza") @map("created_timezone")
  updatedAt               DateTime            @updatedAt @map("updated_at")
  deletedAt               DateTime?           @map("deleted_at")
  attachments             Attachment[]
  completionHistory       CompletionHistory[]
  recurrence              RecurrenceRule?
  tags                    ReminderTag[]
  assignedTo              User?               @relation("AssignedTo", fields: [assignedToId], references: [id])
  list                    List                @relation(fields: [listId], references: [id], onDelete: Cascade)
  parent                  Reminder?           @relation("ReminderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children                Reminder[]          @relation("ReminderHierarchy")
  section                 Section?            @relation(fields: [sectionId], references: [id])

  @@index([listId, completed, order])
  @@index([sectionId])
  @@index([parentId])
  @@index([utcDatetime])
  @@index([assignedToId])
  @@map("reminders")
}

model Tag {
  id        String        @id @default(cuid())
  name      String
  color     String        @default("blue")
  userId    String        @map("user_id")
  createdAt DateTime      @default(now()) @map("created_at")
  reminders ReminderTag[]
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@index([userId])
  @@map("tags")
}

model ReminderTag {
  reminderId String   @map("reminder_id")
  tagId      String   @map("tag_id")
  createdAt  DateTime @default(now()) @map("created_at")
  reminder   Reminder @relation(fields: [reminderId], references: [id], onDelete: Cascade)
  tag        Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([reminderId, tagId])
  @@map("reminder_tags")
}

model RecurrenceRule {
  id                String    @id @default(cuid())
  reminderId        String    @unique @map("reminder_id")
  rruleString       String    @map("rrule_string")
  lastGeneratedDate DateTime? @map("last_generated_date") @db.Date
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  reminder          Reminder  @relation(fields: [reminderId], references: [id], onDelete: Cascade)

  @@map("recurrence_rules")
}

model CompletionHistory {
  id             String   @id @default(cuid())
  reminderId     String   @map("reminder_id")
  completedAt    DateTime @default(now()) @map("completed_at")
  occurrenceDate DateTime @map("occurrence_date") @db.Date
  reminder       Reminder @relation(fields: [reminderId], references: [id], onDelete: Cascade)

  @@index([reminderId])
  @@index([occurrenceDate])
  @@map("completion_history")
}

model Attachment {
  id            String   @id @default(cuid())
  reminderId    String   @map("reminder_id")
  vercelBlobUrl String   @map("vercel_blob_url")
  filename      String
  mimeType      String   @map("mime_type")
  size          Int
  createdAt     DateTime @default(now()) @map("created_at")
  reminder      Reminder @relation(fields: [reminderId], references: [id], onDelete: Cascade)

  @@index([reminderId])
  @@map("attachments")
}

enum ViewMode {
  LIST
  KANBAN
}

enum ShareRole {
  VIEWER
  EDITOR
  ADMIN
}

enum Priority {
  NONE
  LOW
  MEDIUM
  HIGH
}

enum CompletedPosition {
  MOVE_TO_BOTTOM
  KEEP_IN_PLACE
}

enum CompletedVisibility {
  SHOW_TODAY_ONLY
  HIDE
  SHOW_ALL
}
